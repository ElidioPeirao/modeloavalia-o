import React, { useState, useEffect } from 'react';
import { 
  Plus, Trash2, Printer, Upload, Image as ImageIcon, X, ChevronDown, ChevronUp, 
  BookOpen, Search, Check, Download, RefreshCw, Clipboard, Cloud, Save, 
  DownloadCloud, Loader2, FileText, Database, Lock, LogIn, User, Key, School,
  List, CheckSquare, Sparkles, Wand2, AlertTriangle
} from 'lucide-react';
import { initializeApp } from "firebase/app";
import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "firebase/auth";
import { 
  getFirestore, collection, addDoc, deleteDoc, doc, onSnapshot, query, updateDoc 
} from "firebase/firestore";

/* --- CONFIGURAÇÃO DO FIREBASE --- */
const firebaseConfig = {
  apiKey: "AIzaSyDnpVYSC2v3Pbr4DGOxf-sKvcRhFFqtWRE",
  authDomain: "maintence-6ef08.firebaseapp.com",
  projectId: "maintence-6ef08",
  storageBucket: "maintence-6ef08.firebasestorage.app",
  messagingSenderId: "1085348103519",
  appId: "1:1085348103519:web:06c21952276975ab5022ea",
  measurementId: "G-31S2V238QE"
};

// Inicialização do Firebase
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = 'sistema-escolar-v1';

// --- API KEY DO GEMINI ---
const apiKey = "AIzaSyAF9FNs-30DnqlImJ90_EtbgXJj2WrVYFA"; 

const App = () => {
  // --- ESTADOS DE AUTENTICAÇÃO ---
  const [isAuthenticated, setIsAuthenticated] = useState(false);
  const [loginUser, setLoginUser] = useState("");
  const [loginPass, setLoginPass] = useState("");
  const [firebaseUser, setFirebaseUser] = useState(null);

  // --- ESTADOS GERAIS ---
  const [activeTab, setActiveTab] = useState('edit');
  const [loading, setLoading] = useState(false);

  // --- ESTADOS DO BANCO DE DADOS (CURSOS) ---
  const [coursesList, setCoursesList] = useState([]); 
  const [selectedCourseId, setSelectedCourseId] = useState(""); 
  const [currentCourseData, setCurrentCourseData] = useState({}); 

  // --- ESTADOS DO EDITOR ---
  const [header, setHeader] = useState({
    institution: 'SENAI',
    unitName: 'Serviço Nacional de Aprendizagem Industrial',
    docente: '',
    curso: '', 
    unidadeCurricular: '',
    turma: '',
    studentName: '',
    data: '',
    estado: 'Santa Catarina'
  });

  const [questions, setQuestions] = useState([
    {
      id: 1,
      capacidade: '',
      contexto: '',
      comando: '',
      image: null,
      lines: 5,
      type: 'text', 
      options: ['', '', '', ''], 
      selectedUC: '', 
    }
  ]);

  const [formulas, setFormulas] = useState('');
  const [footerText, setFooterText] = useState('Boa Prova!');

  // --- ESTADOS DE MODAL (Importação/IA) ---
  const [showImportModal, setShowImportModal] = useState(false);
  const [importName, setImportName] = useState("");
  const [importJson, setImportJson] = useState("");

  const [showAiModal, setShowAiModal] = useState(false);
  const [aiTopic, setAiTopic] = useState("");
  const [aiQuestionCount, setAiQuestionCount] = useState(5);
  const [aiLoadingText, setAiLoadingText] = useState("");

  // --- EFEITOS (FIREBASE) ---
  useEffect(() => {
    const initAuth = async () => {
      try {
        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
            await signInWithCustomToken(auth, __initial_auth_token);
        } else {
            await signInAnonymously(auth);
        }
      } catch (error) {
        console.error("Erro na conexão:", error);
      }
    };
    initAuth();
    const unsubscribe = onAuthStateChanged(auth, setFirebaseUser);
    return () => unsubscribe();
  }, []);

  useEffect(() => {
    if (!firebaseUser) return;
    const q = query(collection(db, 'courses'));
    const unsubscribe = onSnapshot(q, (snapshot) => {
      const courses = snapshot.docs.map(doc => ({
        id: doc.id,
        ...doc.data()
      }));
      courses.sort((a, b) => a.name.localeCompare(b.name));
      setCoursesList(courses);
    }, (error) => {
        console.error("Erro ao buscar cursos:", error);
    });
    return () => unsubscribe();
  }, [firebaseUser]);

  useEffect(() => {
    if (selectedCourseId) {
      const course = coursesList.find(c => c.id === selectedCourseId);
      if (course) {
        setCurrentCourseData(course.data || {});
        setHeader(prev => ({ ...prev, curso: course.name }));
      }
    } else {
      setCurrentCourseData({});
    }
  }, [selectedCourseId, coursesList]);


  // --- HANDLERS DE LOGIN ---
  const handleLogin = (e) => {
    e.preventDefault();
    if (loginUser === "admin" && loginPass === "admin") {
      setIsAuthenticated(true);
    } else {
      alert("Usuário ou senha incorretos! (Dica: admin / admin)");
    }
  };

  const handleLogout = () => {
    setIsAuthenticated(false);
    setLoginUser("");
    setLoginPass("");
  };

  // --- INTEGRAÇÃO COM GEMINI AI ---
  const generateImageWithGemini = async (promptText) => {
    try {
      // CORREÇÃO: Voltando para o imagen-4.0-generate-001 mas simplificando o payload
      // O endpoint predict geralmente exige 'instances' como array.
      // Removemos aspectRatio para evitar Bad Request (400).
      const response = await fetch(
        `https://generativelanguage.googleapis.com/v1beta/models/imagen-4.0-generate-001:predict?key=${apiKey}`,
        {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            instances: [
              { 
                prompt: promptText + ", technical 2D diagram style, clean lines, black and white educational illustration, schematic, isolated on white background, no text" 
              }
            ],
            parameters: { 
              sampleCount: 1
              // Removido aspectRatio para máxima compatibilidade
            }
          })
        }
      );
      
      const data = await response.json();

      if (!response.ok) {
          console.error("Erro detalhado da API de Imagem:", data);
          return null;
      }

      if (data.predictions && data.predictions[0] && data.predictions[0].bytesBase64Encoded) {
        return `data:image/png;base64,${data.predictions[0].bytesBase64Encoded}`;
      }
      return null;
    } catch (error) {
      console.error("Erro crítico ao tentar gerar imagem:", error);
      return null;
    }
  };

  const handleGenerateAI = async () => {
    
    if (!selectedCourseId) {
      alert("Por favor, selecione um curso primeiro.");
      return;
    }
    if (!aiTopic.trim()) {
      alert("Digite um tema para a avaliação.");
      return;
    }

    setLoading(true);
    setAiLoadingText("Planejando avaliação com Gemini 2.5 Flash...");
    
    try {
      const courseName = header.curso || "Curso Técnico";
      const ucName = header.unidadeCurricular || "Geral";
      
      // Prompt melhorado para garantir formato JSON
      const prompt = `
        Você é um assistente acadêmico do SENAI. Crie uma avaliação técnica profissional.
        Curso: ${courseName}
        UC: ${ucName}
        Tema: ${aiTopic}
        Quantidade: ${aiQuestionCount} questões.
        
        IMPORTANTE: Responda APENAS com o JSON puro, sem markdown, sem \`\`\`json.
        
        Siga RIGOROSAMENTE este formato JSON:
        [
          {
            "capacidade": "string (capacidade técnica do currículo)",
            "contexto": "string (uma situação real de trabalho, curta)",
            "comando": "string (a pergunta clara)",
            "type": "multiple_choice" ou "text",
            "options": ["alternativa A", "alternativa B", "alternativa C", "alternativa D"] (apenas se type for multiple_choice),
            "imagePrompt": "string (descrição em INGLÊS de um diagrama técnico para esta questão, ex: 'schematic of a circuit breaker')"
          }
        ]
      `;

      // Modelo: gemini-2.5-flash-preview-09-2025
      const response = await fetch(
        `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`,
        {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            contents: [{ parts: [{ text: prompt }] }],
            generationConfig: { 
                responseMimeType: "application/json" 
            }
          })
        }
      );

      const data = await response.json();

      if (!response.ok) {
          console.error("Erro API Texto:", data);
          throw new Error(`Erro Gemini: ${data.error?.message || response.status}`);
      }
      
      let text = data.candidates?.[0]?.content?.parts?.[0]?.text;
      if (!text) throw new Error("A IA não retornou texto.");
      
      const generatedQuestions = JSON.parse(text);

      const finalQuestions = [];
      
      for (let i = 0; i < generatedQuestions.length; i++) {
        const q = generatedQuestions[i];
        setAiLoadingText(`Criando questão ${i + 1} de ${generatedQuestions.length}...`);
        
        let imageUrl = null;
        if (q.imagePrompt && q.imagePrompt.length > 5) {
            setAiLoadingText(`Desenhando diagrama para a questão ${i + 1}...`);
            // Pequeno delay
            await new Promise(r => setTimeout(r, 1500)); 
            imageUrl = await generateImageWithGemini(q.imagePrompt);
        }

        finalQuestions.push({
            id: Date.now() + i,
            capacidade: q.capacidade || "",
            contexto: q.contexto || "",
            comando: q.comando || "",
            image: imageUrl,
            lines: 5,
            type: q.type === 'multiple_choice' ? 'multiple_choice' : 'text',
            options: (q.options && q.options.length >= 2) ? q.options : ['', '', '', ''],
            selectedUC: ''
        });
      }

      setQuestions(finalQuestions);
      setShowAiModal(false);
      setAiTopic("");
      setTimeout(() => alert("Sua avaliação foi gerada com sucesso!"), 500);

    } catch (e) {
      console.error(e);
      alert("Erro na geração: " + e.message);
    } finally {
      setLoading(false);
      setAiLoadingText("");
    }
  };

  // --- HANDLERS DO EDITOR ---
  const handleHeaderChange = (e) => {
    const { name, value } = e.target;
    setHeader(prev => ({ ...prev, [name]: value }));
  };

  const addQuestion = () => {
    setQuestions(prev => [
      ...prev,
      {
        id: Date.now(),
        capacidade: '',
        contexto: '',
        comando: '',
        image: null,
        lines: 5,
        type: 'text',
        options: ['', '', '', ''],
        selectedUC: ''
      }
    ]);
  };

  const updateQuestion = (id, field, value) => {
    setQuestions(prev => prev.map(q => q.id === id ? { ...q, [field]: value } : q));
  };

  const removeQuestion = (id) => {
    setQuestions(prev => prev.filter(q => q.id !== id));
  };

  const moveQuestion = (index, direction) => {
    if ((direction === -1 && index === 0) || (direction === 1 && index === questions.length - 1)) return;
    const newQuestions = [...questions];
    const temp = newQuestions[index];
    newQuestions[index] = newQuestions[index + direction];
    newQuestions[index + direction] = temp;
    setQuestions(newQuestions);
  };

  const handleOptionChange = (qId, optIndex, value) => {
    setQuestions(prev => prev.map(q => {
      if (q.id !== qId) return q;
      const newOptions = [...q.options];
      newOptions[optIndex] = value;
      return { ...q, options: newOptions };
    }));
  };

  const addOption = (qId) => {
    setQuestions(prev => prev.map(q => {
      if (q.id !== qId) return q;
      return { ...q, options: [...q.options, ''] };
    }));
  };

  const removeOption = (qId, optIndex) => {
    setQuestions(prev => prev.map(q => {
      if (q.id !== qId) return q;
      const newOptions = q.options.filter((_, i) => i !== optIndex);
      return { ...q, options: newOptions };
    }));
  };

  const handleImageUpload = (id, e) => {
    const file = e.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onloadend = () => {
        updateQuestion(id, 'image', reader.result);
      };
      reader.readAsDataURL(file);
    }
  };

  const handlePrint = () => {
    if (window) {
        window.focus();
        setTimeout(() => {
            window.print();
        }, 100);
    }
  };

  const handleSaveNewCourse = async () => {
    if (!importName.trim() || !importJson.trim()) {
      alert("Preencha o nome do curso e o JSON.");
      return;
    }
    try {
      const parsedData = JSON.parse(importJson);
      setLoading(true);
      await addDoc(collection(db, 'courses'), {
        name: importName,
        data: parsedData,
        createdAt: Date.now()
      });
      alert("Curso salvo com sucesso!");
      setImportName("");
      setImportJson("");
      setShowImportModal(false);
    } catch (e) {
      console.error(e);
      alert("Erro ao salvar curso: Verifique se o JSON é válido.");
    } finally {
      setLoading(false);
    }
  };

  const handleDeleteCourse = async (id, name) => {
    if (confirm(`Tem certeza que deseja excluir o curso "${name}"?`)) {
      try {
        await deleteDoc(doc(db, 'courses', id));
      } catch (e) {
        alert("Erro ao excluir.");
      }
    }
  };

  return (
    <div className="min-h-screen bg-gray-100 flex flex-col md:flex-row relative font-sans">
      
      {/* MODAL DE IMPORTAÇÃO DE CURSO */}
      {showImportModal && (
        <div className="fixed inset-0 z-50 bg-black bg-opacity-50 flex items-center justify-center p-4 print:hidden">
          <div className="bg-white rounded-lg shadow-xl w-full max-w-2xl p-6">
            <div className="flex justify-between items-center mb-4 border-b pb-2">
              <h3 className="font-bold text-lg text-blue-900">Cadastrar Novo Curso</h3>
              <button onClick={() => setShowImportModal(false)} className="text-gray-500 hover:text-red-500">
                <X size={24} />
              </button>
            </div>
            <div className="space-y-4">
              <div>
                <label className="block text-xs font-bold text-gray-700 mb-1">Nome do Curso</label>
                <input type="text" className="w-full p-2 border rounded" placeholder="Ex: Eletricista Industrial" value={importName} onChange={(e) => setImportName(e.target.value)} />
              </div>
              <div>
                <label className="block text-xs font-bold text-gray-700 mb-1">Dados (JSON)</label>
                <textarea className="w-full p-2 border rounded font-mono text-xs h-40" placeholder='{ "Matéria 1": ["Capacidade A"], ... }' value={importJson} onChange={(e) => setImportJson(e.target.value)} />
              </div>
            </div>
            <div className="flex justify-end gap-2 mt-4">
              <button onClick={() => setShowImportModal(false)} className="px-4 py-2 text-gray-600 border rounded">Cancelar</button>
              <button onClick={handleSaveNewCourse} disabled={loading} className="px-4 py-2 bg-blue-600 text-white rounded font-bold hover:bg-blue-700 flex items-center gap-2">
                {loading ? <Loader2 className="animate-spin" size={16}/> : <Save size={16}/>} Salvar Curso
              </button>
            </div>
          </div>
        </div>
      )}

      {/* MODAL IA */}
      {showAiModal && (
        <div className="fixed inset-0 z-50 bg-black bg-opacity-50 flex items-center justify-center p-4 print:hidden">
          <div className="bg-white rounded-lg shadow-xl w-full max-w-md p-6">
            <div className="flex justify-between items-center mb-4 border-b pb-2">
              <h3 className="font-bold text-lg text-purple-900 flex items-center gap-2">
                <Sparkles size={20} /> IA - Assistente SENAI
              </h3>
              <button onClick={() => setShowAiModal(false)} className="text-gray-500 hover:text-red-500">
                <X size={24} />
              </button>
            </div>
            
            {loading ? (
                <div className="flex flex-col items-center justify-center py-8 text-center animate-pulse">
                    <Loader2 size={48} className="text-purple-600 animate-spin mb-4" />
                    <p className="text-sm font-bold text-gray-700">{aiLoadingText}</p>
                    <p className="text-xs text-gray-400 mt-2">Isso pode levar alguns segundos por imagem...</p>
                </div>
            ) : (
                <div className="space-y-4">
                    <div className="bg-purple-50 p-3 rounded text-xs text-purple-800 border border-purple-200">
                        <p>A IA usará o contexto do curso selecionado no editor para gerar questões e diagramas.</p>
                    </div>
                    <div>
                        <label className="block text-xs font-bold text-gray-700 mb-1">Tema da Avaliação</label>
                        <input type="text" className="w-full p-2 border rounded outline-none focus:ring-2 focus:ring-purple-500" placeholder="Ex: Componentes Eletrônicos, NR10..." value={aiTopic} onChange={(e) => setAiTopic(e.target.value)} />
                    </div>
                    <div>
                        <label className="block text-xs font-bold text-gray-700 mb-1">Questões</label>
                        <select className="w-full p-2 border rounded" value={aiQuestionCount} onChange={(e) => setAiQuestionCount(Number(e.target.value))}>
                            <option value="3">3 Itens</option>
                            <option value="5">5 Itens</option>
                            <option value="10">10 Itens</option>
                        </select>
                    </div>
                    <div className="flex justify-end gap-2 mt-6">
                        <button onClick={() => setShowAiModal(false)} className="px-4 py-2 text-gray-600 border rounded">Cancelar</button>
                        <button onClick={handleGenerateAI} className="px-4 py-2 bg-purple-600 text-white rounded font-bold hover:bg-purple-700 flex items-center gap-2">
                            <Wand2 size={16}/> Gerar Avaliação ✨
                        </button>
                    </div>
                </div>
            )}
          </div>
        </div>
      )}

      {/* SIDEBAR */}
      <div className={`w-full md:w-2/5 lg:w-1/3 bg-white border-r shadow-lg overflow-y-auto h-screen print:hidden ${activeTab === 'preview' ? 'hidden md:block' : 'block'}`}>
        <div className="sticky top-0 z-10 bg-white border-b">
            <div className="flex justify-between items-center p-3 bg-blue-900 text-white">
                <span className="font-bold text-sm flex items-center gap-2"><Database size={16} /> MechPlanner Admin</span>
                {isAuthenticated && (
                  <button onClick={handleLogout} className="text-xs bg-blue-800 hover:bg-blue-700 px-2 py-1 rounded flex items-center gap-1"><Lock size={12} /> Sair</button>
                )}
            </div>
            <div className="flex border-b">
                <button onClick={() => setActiveTab('edit')} className={`flex-1 py-3 text-sm font-bold flex items-center justify-center gap-2 ${activeTab === 'edit' ? 'text-blue-600 border-b-2 border-blue-600 bg-blue-50' : 'text-gray-500 hover:bg-gray-50'}`}><FileText size={16} /> Editor</button>
                <button onClick={() => setActiveTab('courses')} className={`flex-1 py-3 text-sm font-bold flex items-center justify-center gap-2 ${activeTab === 'courses' ? 'text-green-600 border-b-2 border-green-600 bg-green-50' : 'text-gray-500 hover:bg-gray-50'}`}><School size={16} /> Cursos</button>
            </div>
        </div>

        {activeTab === 'courses' && (
            <div className="p-6">
                {!isAuthenticated ? (
                    <div className="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                        <div className="flex justify-center mb-4"><div className="bg-green-100 p-3 rounded-full"><Lock size={32} className="text-green-600" /></div></div>
                        <h2 className="text-lg font-bold text-center text-gray-800 mb-2">Área Restrita</h2>
                        <form onSubmit={handleLogin} className="space-y-3">
                            <div><label className="block text-xs font-bold text-gray-700 uppercase mb-1">Usuário</label><input type="text" value={loginUser} onChange={(e) => setLoginUser(e.target.value)} className="w-full p-2 border rounded" placeholder="admin" /></div>
                            <div><label className="block text-xs font-bold text-gray-700 uppercase mb-1">Senha</label><input type="password" value={loginPass} onChange={(e) => setLoginPass(e.target.value)} className="w-full p-2 border rounded" placeholder="•••••" /></div>
                            <button type="submit" className="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 rounded">Entrar</button>
                        </form>
                    </div>
                ) : (
                    <div className="space-y-4">
                        <div className="bg-green-50 p-4 rounded-lg border border-green-200">
                            <h2 className="text-green-900 font-bold text-sm mb-2">Gerenciar Cursos</h2>
                            <button onClick={() => setShowImportModal(true)} className="w-full bg-green-600 text-white py-2 rounded text-xs font-bold hover:bg-green-700 flex items-center gap-2"><Plus size={16} /> Cadastrar Novo Curso</button>
                        </div>
                        <h3 className="text-xs font-bold text-gray-500 uppercase mt-4">Cursos Salvos ({coursesList.length})</h3>
                        <div className="space-y-2">
                            {coursesList.map(course => (
                                <div key={course.id} className="bg-white border p-3 rounded flex justify-between items-center shadow-sm">
                                    <div><div className="font-bold text-sm text-gray-800">{course.name}</div><div className="text-xs text-gray-500">{Object.keys(course.data || {}).length} Unidades Curriculares</div></div>
                                    <button onClick={() => handleDeleteCourse(course.id, course.name)} className="text-red-400 hover:text-red-600 p-2 hover:bg-red-50 rounded"><Trash2 size={16} /></button>
                                </div>
                            ))}
                        </div>
                    </div>
                )}
            </div>
        )}

        {activeTab === 'edit' && (
            <div className="p-6 space-y-6">
                <div className="bg-blue-50 p-4 rounded-lg border border-blue-200 shadow-sm">
                    <label className="text-xs font-bold text-blue-800 uppercase mb-2 block flex items-center gap-2"><School size={14} /> Selecione o Curso</label>
                    <select className="w-full p-2 border border-blue-300 rounded text-sm bg-white" value={selectedCourseId} onChange={(e) => setSelectedCourseId(e.target.value)}>
                        <option value="">-- Selecione o curso para carregar UCs --</option>
                        {coursesList.map(c => (<option key={c.id} value={c.id}>{c.name}</option>))}
                    </select>
                </div>

                <div className="flex justify-between items-center">
                    <h1 className="text-2xl font-bold text-gray-800">Editor</h1>
                    <div className="flex gap-2">
                        <button onClick={() => setShowAiModal(true)} className="bg-purple-600 hover:bg-purple-700 text-white px-3 py-2 rounded shadow-md flex items-center gap-2 text-xs font-bold transition-all transform hover:scale-105" title="Gerar com IA"><Sparkles size={16} /> Gerar com IA</button>
                        <button onClick={handlePrint} className="bg-gray-800 hover:bg-gray-900 text-white p-2 rounded shadow-md" title="Imprimir / PDF"><Printer size={20} /></button>
                    </div>
                </div>

                <div className="bg-gray-50 p-4 rounded-lg border border-gray-200">
                    <h2 className="text-xs font-bold text-gray-500 uppercase mb-3">Cabeçalho</h2>
                    <div className="grid gap-3">
                        <input type="text" name="docente" placeholder="Nome do Docente" value={header.docente} onChange={handleHeaderChange} className="w-full p-2 border rounded text-sm" />
                        <div className="relative">
                             <input type="text" name="curso" placeholder="Nome do Curso" value={header.curso} onChange={handleHeaderChange} className="w-full p-2 border rounded text-sm bg-gray-100" />
                             <Lock size={12} className="absolute right-2 top-3 text-gray-400" />
                        </div>
                        <div className="grid grid-cols-2 gap-2">
                            {selectedCourseId && Object.keys(currentCourseData).length > 0 ? (
                                <select name="unidadeCurricular" value={header.unidadeCurricular} onChange={handleHeaderChange} className="w-full p-2 border rounded text-sm bg-white">
                                    <option value="">Selecione a UC...</option>
                                    {Object.keys(currentCourseData).map(uc => (<option key={uc} value={uc}>{uc}</option>))}
                                </select>
                            ) : (
                                <input type="text" name="unidadeCurricular" placeholder="Unidade Curricular" value={header.unidadeCurricular} onChange={handleHeaderChange} className="w-full p-2 border rounded text-sm" />
                            )}
                            <input type="text" name="turma" placeholder="Turma" value={header.turma} onChange={handleHeaderChange} className="w-full p-2 border rounded text-sm" />
                        </div>
                        <input type="text" name="studentName" placeholder="Nome do Estudante (Opcional)" value={header.studentName} onChange={handleHeaderChange} className="w-full p-2 border rounded text-sm" />
                        <input type="text" name="data" placeholder="Data da Avaliação" value={header.data} onChange={handleHeaderChange} className="w-full p-2 border rounded text-sm" />
                    </div>
                </div>

                <div className="space-y-4">
                    <div className="flex justify-between items-center">
                        <h2 className="text-xs font-bold text-gray-500 uppercase">Itens da Avaliação ({questions.length})</h2>
                        <button onClick={addQuestion} className="flex items-center gap-1 text-xs bg-green-100 text-green-700 px-3 py-1 rounded-full font-medium hover:bg-green-200"><Plus size={14} /> Adicionar Item</button>
                    </div>

                    {questions.map((q, index) => (
                        <div key={q.id} className="bg-white border border-gray-300 rounded-lg p-4 shadow-sm relative group transition-all hover:border-blue-300">
                             <div className="flex justify-between items-center mb-2">
                                <div className="flex items-center gap-3">
                                    <span className="font-bold text-blue-800">ITEM {index + 1}</span>
                                    <select value={q.type} onChange={(e) => updateQuestion(q.id, 'type', e.target.value)} className="text-xs border rounded p-1 bg-gray-50 text-gray-700 outline-none">
                                        <option value="text">Dissertativa</option>
                                        <option value="multiple_choice">Múltipla Escolha</option>
                                    </select>
                                </div>
                                <div className="flex gap-1">
                                    <button onClick={() => moveQuestion(index, -1)} className="p-1 text-gray-400 hover:text-gray-600 disabled:opacity-30"><ChevronUp size={16} /></button>
                                    <button onClick={() => moveQuestion(index, 1)} className="p-1 text-gray-400 hover:text-gray-600 disabled:opacity-30"><ChevronDown size={16} /></button>
                                    <button onClick={() => removeQuestion(q.id)} className="p-1 text-red-400 hover:text-red-600 ml-2"><Trash2 size={16} /></button>
                                </div>
                            </div>

                            {selectedCourseId && (
                                <div className="bg-yellow-50 p-3 rounded border border-yellow-200 mb-3">
                                    <div className="flex items-center gap-2 mb-2 text-yellow-800"><Search size={14} /><span className="text-xs font-bold uppercase">Assistente de Currículo</span></div>
                                    <select className="w-full p-1.5 border rounded text-xs mb-2 bg-white" value={q.selectedUC || ''} onChange={(e) => updateQuestion(q.id, 'selectedUC', e.target.value)}>
                                        <option value="">1. Selecione a UC...</option>
                                        {Object.keys(currentCourseData).map(uc => (<option key={uc} value={uc}>{uc}</option>))}
                                    </select>
                                    <select className="w-full p-1.5 border rounded text-xs bg-white disabled:opacity-50" disabled={!q.selectedUC} onChange={(e) => {
                                            if (e.target.value) {
                                                const currentVal = q.capacidade || "";
                                                const newVal = currentVal ? currentVal + "\n" + e.target.value : e.target.value;
                                                updateQuestion(q.id, 'capacidade', newVal);
                                            }
                                        }} value="">
                                        <option value="">2. Adicionar Capacidade (Clica para incluir)</option>
                                        {q.selectedUC && currentCourseData[q.selectedUC]?.map((cap, i) => (<option key={i} value={cap}>{cap.substring(0, 80)}...</option>))}
                                    </select>
                                </div>
                            )}

                            <div className="space-y-3">
                                <div><label className="text-xs font-semibold text-gray-500">Capacidades Avaliadas</label><textarea value={q.capacidade} onChange={(e) => updateQuestion(q.id, 'capacidade', e.target.value)} className="w-full p-2 border rounded text-sm h-24 resize-none focus:ring-2 focus:ring-blue-400" placeholder="Lista de capacidades..." /></div>
                                <div><label className="text-xs font-semibold text-gray-500">Contextualização (Contexto)</label><textarea value={q.contexto} onChange={(e) => updateQuestion(q.id, 'contexto', e.target.value)} className="w-full p-2 border rounded text-sm h-16 resize-none focus:ring-2 focus:ring-blue-400" placeholder="Cenário ou problema..." /></div>
                                <div><label className="text-xs font-semibold text-gray-500">Instrução / Pergunta (Comando)</label><textarea value={q.comando} onChange={(e) => updateQuestion(q.id, 'comando', e.target.value)} className="w-full p-2 border rounded text-sm h-16 resize-none focus:ring-2 focus:ring-blue-400" placeholder="A pergunta em si..." /></div>
                                <div className="flex items-center gap-2">
                                    <label className="cursor-pointer bg-gray-100 hover:bg-gray-200 text-gray-600 px-3 py-1 rounded text-xs flex items-center gap-1 transition-all"><ImageIcon size={14} /> Adicionar Imagem<input type="file" className="hidden" accept="image/*" onChange={(e) => handleImageUpload(q.id, e)} /></label>
                                    {q.image && (<button onClick={() => updateQuestion(q.id, 'image', null)} className="text-red-500 text-xs hover:underline flex items-center gap-1"><X size={12}/> Remover</button>)}
                                </div>
                                {q.image && (<div className="h-40 w-full bg-gray-50 border rounded flex items-center justify-center overflow-hidden"><img src={q.image} className="h-full object-contain" alt="Preview" /></div>)}

                                {q.type === 'text' ? (
                                    <div className="flex items-center gap-2 mt-2"><label className="text-xs text-gray-500 font-medium">Linhas para resposta:</label><input type="number" min="0" max="20" value={q.lines || 0} onChange={(e) => updateQuestion(q.id, 'lines', parseInt(e.target.value))} className="w-16 p-1 border rounded text-sm" /></div>
                                ) : (
                                    <div className="mt-2 bg-gray-50 p-3 rounded border border-gray-200">
                                        <label className="text-xs font-semibold text-gray-500 block mb-2">Alternativas</label>
                                        <div className="space-y-2">
                                            {q.options.map((opt, idx) => (
                                                <div key={idx} className="flex gap-2 items-center group/opt">
                                                    <span className="text-sm font-bold w-4">{String.fromCharCode(97 + idx)})</span>
                                                    <input type="text" value={opt} onChange={(e) => handleOptionChange(q.id, idx, e.target.value)} className="flex-1 p-1.5 border rounded text-sm focus:ring-1 focus:ring-blue-400" placeholder={`Opção ${idx + 1}`} />
                                                    <button onClick={() => removeOption(q.id, idx)} className="text-red-400 opacity-0 group-hover/opt:opacity-100 transition-opacity"><X size={14} /></button>
                                                </div>
                                            ))}
                                        </div>
                                        <button onClick={() => addOption(q.id)} className="mt-2 text-xs text-blue-600 flex items-center gap-1 hover:underline"><Plus size={12} /> Adicionar Opção</button>
                                    </div>
                                )}
                            </div>
                        </div>
                    ))}
                </div>

                <div className="bg-gray-50 p-4 rounded-lg border border-gray-200">
                    <h2 className="text-xs font-bold text-gray-500 uppercase mb-2">Rodapé e Fórmulas</h2>
                    <textarea value={formulas} onChange={(e) => setFormulas(e.target.value)} className="w-full p-2 border rounded text-sm h-20 mb-2 font-mono" placeholder="Fórmulas úteis para a prova..." />
                    <input type="text" value={footerText} onChange={(e) => setFooterText(e.target.value)} className="w-full p-2 border rounded text-sm" placeholder="Frase motivacional de rodapé" />
                </div>
            </div>
        )}
      </div>

      <div className={`w-full md:w-3/5 lg:w-2/3 bg-gray-500 p-8 overflow-y-auto h-screen print:w-full print:p-0 print:h-auto print:bg-white print:overflow-visible print:block ${activeTab === 'preview' ? 'block' : 'hidden md:block'}`}>
         <div id="print-area" className="bg-white shadow-2xl mx-auto w-[210mm] min-h-[297mm] p-[2cm] pt-[3cm] text-black font-sans text-[11pt] leading-tight print:shadow-none">
            <div className="border-2 border-black flex mb-6">
                <div className="w-[20%] border-r-2 border-black flex flex-col justify-center items-center p-2 text-center">
                    <h1 className="text-2xl font-black italic tracking-tighter">SENAI</h1>
                    <span className="text-[0.6rem] leading-tight mt-1 uppercase">{header.unitName}</span>
                </div>
                <div className="w-[60%] flex flex-col">
                    <div className="border-b border-black p-1 pl-2"><span className="font-bold mr-2">Docente:</span> {header.docente}</div>
                    <div className="border-b border-black p-1 pl-2"><span className="font-bold mr-2">Curso:</span> {header.curso}</div>
                    <div className="border-b border-black p-1 pl-2"><span className="font-bold mr-2">UC:</span> {header.unidadeCurricular}</div>
                    <div className="border-b border-black p-1 pl-2"><span className="font-bold mr-2">Turma:</span> {header.turma}</div>
                    <div className="p-1 pl-2 flex-1 flex items-center"><span className="font-bold mr-2">Estudante:</span> {header.studentName}</div>
                </div>
                <div className="w-[20%] border-l-2 border-black flex flex-col">
                    <div className="border-b border-black p-1 pl-2 h-[50%] flex flex-col justify-center">
                        <span className="font-bold text-xs">Data:</span>
                        <div className="text-center font-bold">{header.data || '___/___/___'}</div>
                    </div>
                    <div className="p-1 h-[50%] bg-gray-100 flex items-start pt-1 justify-center text-[10px] uppercase text-center font-bold">Desempenho</div>
                </div>
            </div>

            <h2 className="text-center font-bold text-xl uppercase border-b-2 border-black mb-6 pb-1">Avaliação</h2>

            <div className="space-y-6">
                {questions.map((q, i) => (
                    <div key={q.id} className="break-inside-avoid border border-black page-break-inside-avoid">
                        <div className="bg-black text-white px-2 py-1 font-bold text-sm w-fit print-color-adjust">ITEM {i + 1}</div>
                        <div className="p-3">
                            {q.capacidade && (<div className="mb-2 text-sm"><span className="font-bold">CAPACIDADE(S):</span> <div className="whitespace-pre-wrap ml-1">{q.capacidade}</div></div>)}
                            {q.contexto && <div className="mb-2 text-sm"><span className="font-bold italic">Contexto:</span> {q.contexto}</div>}
                            <div className="text-sm"><span className="font-bold">Comando:</span> {q.comando}</div>
                            {q.image && (<div className="my-4 flex justify-center"><img src={q.image} className="max-h-[8cm] max-w-full rounded border shadow-sm" alt="Ilustração da Questão" /></div>)}
                            {q.type === 'text' ? (
                                q.lines > 0 && (<div className="mt-4 space-y-4 pt-2">{Array.from({length: q.lines}).map((_, k) => (<div key={k} className="border-b border-gray-400 w-full h-6"></div>))}</div>)
                            ) : (
                                <div className="mt-4 space-y-2 pl-2">{q.options.map((opt, k) => (<div key={k} className="flex gap-2"><span className="font-bold">{String.fromCharCode(97 + k)})</span><span>{opt}</span></div>))}</div>
                            )}
                        </div>
                    </div>
                ))}
            </div>

            <div className="mt-12 pt-4 border-t-2 border-black break-inside-avoid page-break-inside-avoid">
                {formulas && (<div className="mb-4 p-4 bg-gray-50 border border-gray-300 rounded font-mono text-sm whitespace-pre-wrap text-center">{formulas}</div>)}
                <div className="text-center text-gray-500 italic text-sm mt-4">{footerText}</div>
            </div>
         </div>
      </div>

      <style>{`
        @media print {
            @page { 
                margin-top: 3cm; 
                margin-bottom: 2cm; 
                margin-left: 3cm; 
                margin-right: 2cm; 
                size: A4 portrait; 
            }
            body { 
                visibility: hidden; 
                margin: 0; 
                background: white !important;
            }
            #print-area { 
                visibility: visible; 
                position: absolute; 
                left: 0; 
                top: 0; 
                width: 100% !important; 
                margin: 0 !important; 
                padding: 0 !important; 
                background: transparent !important; 
                box-shadow: none !important; 
            }
            #print-area * { visibility: visible; }
            .page-break-inside-avoid { page-break-inside: avoid; break-inside: avoid; }
            * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
        }
      `}</style>
    </div>
  );
};

export default App;
